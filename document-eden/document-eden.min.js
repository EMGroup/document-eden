status=[],error=[];let TYPE_OBSERVABLE=1,TYPE_EXPRESSION=0,TYPE_ASSIGNMENT=2,TYPE_DEFINITION=3,TYPE_INVALID=-1,debounceTimeout=(DocumentEden={Utils:{}},null),handleInput=e=>{clearTimeout(debounceTimeout),debounceTimeout=setTimeout(()=>{var e=document.querySelector("#observableEditor input");Number(e.value).toString()==e.value?root.lookup(e.parentElement.getAttribute("data-observable")).assign(Number(e.value),root.scope,EdenSymbol.jsAgent):root.lookup(e.parentElement.getAttribute("data-observable")).assign(e.value,root.scope,EdenSymbol.jsAgent)},100)},startPos,startPosY,startVal,obsChange=!1;function mouseMove(e){var t=Math.ceil(e.clientX-startPos),n=Math.max(1,(startPosY-e.clientY)/10),t=Math.round(Math.sign(t)*(Math.abs(t)*(n+1))/10);const o=startVal+t;o<0&&(o=0),handleInput(e)}function sanitiseResult(e,t,n){return null==e?"?":e}function showObservableEditor(e){var t=document.querySelector("#observableEditor");e.closest("section")&&e.closest("section").append(t),t.classList.add("active"),t.setAttribute("data-observable",e.getAttribute("data-observable")),DocumentEden.Utils.isNumeric(e.innerText)?t.querySelector("input").setAttribute("type","number"):t.querySelector("input").setAttribute("type","text"),t.querySelector("input").value=e.innerText,t.style.left=e.offsetLeft+"px",t.style.top=e.offsetTop+e.offsetHeight+"px",t.querySelector("input").focus(),t.querySelector("input").setAttribute("tabindex",Number(e.getAttribute("tabindex"))+1)}document.addEventListener("DOMContentLoaded",()=>{var e,t;console.log("Ready, initialising eden"),(eden=new Eden).ready.then(()=>{edenUI=new EdenUI(eden),eden.root.lookup("jseden_parser_cs3").assign(!0,eden.root.scope,EdenSymbol.defaultAgent),eden.root.lookup("jseden_parser_cs3").addJSObserver("parser",(e,t)=>{Eden.AST.version=t?Eden.AST.VERSION_CS3:Eden.AST.VERSION_CS2}),root=eden.root,DocumentEden.loadLanguage("en",async()=>{Eden.Project.newFromExisting("NewProject",eden),Eden.Project.listenTo("load",this,async()=>{DocumentEden.setupEdenQueries(),DocumentEden.loadPlugin("ScriptInput").then(()=>{DocumentEden.loadPlugin("Canvas2D").then(()=>{window.edenProjectLoadedResolve(),setTimeout(()=>{document.querySelectorAll(".eden-picture").forEach(e=>{DocumentEden.initializeCanvas(e)})},1e3)})})})})}),null==document.querySelector("#observableEditor")&&((e=document.createElement("div")).id="observableEditor",e.setAttribute("draggable",!1),(t=document.createElement("input")).setAttribute("type","number"),t.setAttribute("draggable",!1),(document.querySelector(".slides")?document.querySelector(".slides"):document.querySelector("body")).appendChild(e),e.appendChild(t)),document.querySelector("#observableEditor input").addEventListener("input",handleInput),document.addEventListener("keypress",e=>{e.target.matches("span.observable")&&(showObservableEditor(e.target),e.stopPropagation())}),document.addEventListener("mousemove",e=>{obsChange&&(mouseMove(e),e.preventDefault())}),document.addEventListener("dragstart",e=>{e.preventDefault(),e.stopPropagation()}),document.addEventListener("mouseup",e=>{obsChange=!1}),document.querySelector("#observableEditor input").addEventListener("keypress",e=>{"Enter"==e.key&&(e.preventDefault(),document.querySelector("#observableEditor").classList.remove("active")),obsChange=!1}),document.querySelector("#observableEditor input").addEventListener("mouseup",e=>{obsChange=!1,e.stopPropagation()}),document.querySelector("#observableEditor input").addEventListener("blur",e=>{obsChange&&handleInput(ev),document.querySelector("#observableEditor").classList.remove("active"),obsChange=!1}),document.querySelector("#observableEditor input").addEventListener("mousedown",e=>{startPos=e.clientX,startPosY=e.clientY,startVal=parseFloat(e.target.value),console.log("Starting value of ",startVal),isNaN(startVal)&&(startVal=0),obsChange=!0,e.stopPropagation()}),document.addEventListener("click",e=>{e.target.matches(".showhidecode")&&e.target.nextSibling.classList.toggle("invisible"),e.target.matches(".observable")&&showObservableEditor(e.target),e.target.matches(".runAction")&&(DocumentEden.runAction(e.target.getAttribute("data-action")),e.stopPropagation())}),document.querySelector("#observableEditor input").addEventListener("select",()=>{this.selectionStart=this.selectionEnd},!1)},3e3),DocumentEden.setupEdenQueries=function(){document.querySelectorAll("[data-query]").forEach(s=>{console.log("data-query",s),s.getAttributeNames().forEach(e=>{var n=s.getAttribute(e);if(n.includes("£")){let o=[];var r=[],a=(console.log(n),splitAtDelimiters(n,[{left:"£",right:"£",maths:!1}]));console.log(a);for(let e=0;e<a.length;e++)"jseden"==a[e].type?(o[e]={type:"jseden",expression:a[e].data},r.push(a[e].data)):o[e]={type:"text",data:a[e].data};null==s.getAttribute("data-eden-update")&&s.setAttribute("data-eden-update",++dependenciesCreated);let t=()=>{let n="";try{for(let t=0;t<o.length;t++)if("jseden"==o[t].type){let e=o[t].expression;checkTokens(e)==TYPE_EXPRESSION&&(e="DOCUMENT_EDEN_"+DocumentEden.Utils.simpleHash(o[t].expression)),n+=sanitiseResult(root.lookup(e).value())}else n+=o[t].data}catch(e){console.log(e),n="Error"}s.setAttribute(e,n)};r.forEach(e=>{DocumentEden.createDependency(e,s.getAttribute("data-eden-update"),t)})}})});let n=0,e=document.querySelectorAll("script[type='text/jseden'],pre[type='text/jseden']");(async()=>{for(var t of e){let e=t.getAttribute("data-action");null==e&&(e="codeTag"+ ++n,t.setAttribute("data-action",e)),await DocumentEden.executeJSEdenScript(t.innerText,e)}})().then(()=>{document.querySelectorAll("script.display,pre.display").forEach(e=>{var t=e.getAttribute("data-action"),n=null===e.getAttribute("data-width")?600:e.getAttribute("data-width"),o=null===e.getAttribute("data-height")?300:e.getAttribute("data-height"),r="sv"+t,a=edenUI.createEmbedded(r,"ScriptInput","svn"+t,this),t=(root.lookup("view_"+r+"_tabs").assign(["> "+t],root.scope,EdenSymbol.jsAgent),root.lookup("view_"+r+"_current").assign(0,root.scope,EdenSymbol.jsAgent),root.lookup("view_"+r+"_height").assign(o,root.scope,EdenSymbol.jsAgent),root.lookup("view_"+r+"_width").assign(n,root.scope,EdenSymbol.jsAgent),root.lookup("view_"+r+"_showtabs").assign(!1,root.scope,EdenSymbol.jsAgent),root.lookup("view_"+r+"_showbuttons").assign(!1,root.scope,EdenSymbol.jsAgent),document.createElement("div")),r=(t.style.position="relative",t.style.width=n+"px",t.style.height=o+"px",document.createElement("a"));r.classList.add("showhidecode"),r.innerText="Show/hide code",e.parentElement.insertBefore(t,e),e.parentElement.insertBefore(r,t),t.appendChild(a.contents[0])})})},DocumentEden.run=function(o){return new Promise((e,t)=>{let n=new Eden.Fragment("tmp",()=>{n.setSourceInitial(o),n.ast.execute(EdenSymbol.defaultAgent,root.scope,e)})})},DocumentEden.executeJSEdenScript=function(o,r){return new Promise((e,t)=>{console.log("Creating script",r);let n=new Eden.Fragment(r,()=>{n.setSourceInitial(o),n.makeReal(r),n.ast.execute(EdenSymbol.defaultAgent,root.scope,e)})})},DocumentEden.initializeCanvas=function(n){var e=n.getAttribute("data-observable"),t=eden.root.lookup(`view_${e}_width`).value(),o=eden.root.lookup(`view_${e}_height`).value(),t=(null==t?eden.root.lookup(`view_${e}_width`).assign(n.offsetWidth,root.scope,EdenSymbol.jsAgent):n.style.width=t+"px",null==o?eden.root.lookup(`view_${e}_height`).assign(n.offsetWidth,root.scope,EdenSymbol.jsAgent):n.style.height=o+"px",edenUI.createEmbedded(e,"Canvas2D",e,this));n.appendChild(t.contents[0]),DocumentEden.addJSObserver(`view_${e}_width`,(e,t)=>{n.style.width=t+"px"}),DocumentEden.addJSObserver(`view_${e}_height`,(e,t)=>{n.style.height=t+"px"}),eden.root.lookup(`view_${e}_scale`).assign(1,eden.root.scope,EdenSymbol.jsAgent)},DocumentEden.addJSObserver=function(e,n){eden.root.lookup(e).addJSObserver(e+"_update",(e,t)=>{n(e,t)})},DocumentEden.loadPlugin=function(n){return new Promise((e,t)=>{edenUI.loadPlugin(n,EdenSymbol.defaultAgent,e)})},DocumentEden.runAction=function(e,t){console.log("Running action",e),e.includes(">")||(e="> construal > "+e),Eden.Selectors.execute(e,root.scope,()=>{void 0!==t&&t()})},DocumentEden.refreshElement=function(e=document){DocumentEden.renderJSEden(e),e.querySelectorAll(".eden-picture").forEach(e=>{e.getAttribute("data-observable");DocumentEden.initializeCanvas(e)})},DocumentEden.loadLanguage=function(lang,callback){$.getScript(URLUtil.prefix+"js/language/"+lang+".js",function(data){Language.language=lang,eval(data),callback()})};let tabIndexOffset=1;function checkTokens(e){e=new EdenStream(e),e.readToken(),e=e.readToken();return"EOF"==e?TYPE_OBSERVABLE:"="==e?TYPE_ASSIGNMENT:"is"==e?TYPE_DEFINITION:TYPE_EXPRESSION}DocumentEden.renderJSEden=a=>{for(let r=0;r<a.childNodes.length;r++){var s=a.childNodes[r];if(3===s.nodeType){let e=s.textContent,t=s.nextSibling,n=0;for(;t&&t.nodeType===Node.TEXT_NODE;)e+=t.textContent,t=t.nextSibling,n++;let o=!1;"http://www.w3.org/2000/svg"!=s.parentElement.getAttribute("xmlns")&&"g"!=s.parentElement.nodeName||(o=!0);var d=DocumentEden.renderJSEdenInText(e,o);if(d){for(let e=0;e<n;e++)s.nextSibling.remove();r+=d.childNodes.length-1,a.replaceChild(d,s)}else r+=n}else 1===s.nodeType&&DocumentEden.renderJSEden(s)}},DocumentEden.renderJSEdenInText=function(e,o){var a=splitAtDelimiters(e,[{left:"£",right:"£",maths:!1},{left:"€",right:"€",maths:!0}]);if(1===a.length&&"text"===a[0].type)return null;var s=document.createDocumentFragment();for(let t=0;t<a.length;t++)if("text"===a[t].type)s.appendChild(document.createTextNode(a[t].data));else{let r,n=(r=o?document.createElementNS("http://www.w3.org/2000/svg","g"):document.createElement("span"),a[t].data);var d=a[t].type;try{if(n=n.replaceAll("€","$"),"jseden"==d){var i=checkTokens(n);if(i==TYPE_ASSIGNMENT||i==TYPE_DEFINITION){var l=n.split("="),u=(r.classList.add("observable"),r.setAttribute("tabindex",tabIndexOffset),tabIndexOffset+=2,l[0].trim());let e=l[1].trim();DocumentEden.Utils.isNumeric(e)&&(e=Number(e)),r.setAttribute("data-observable",u),root.lookup(u).assign(e,root.scope,EdenSymbol.jsAgent),n=u}null==r.getAttribute("data-eden-update")&&r.setAttribute("data-eden-update",++dependenciesCreated),DocumentEden.createDependency(n,r.getAttribute("data-eden-update"),(e,t)=>{r.tagName,r.innerHTML=sanitiseResult(t,"image",r),window.Reveal&&Reveal.renderMath(r)})}else if("jsedenmaths"==d){let o=[];var c=[],p=splitAtDelimiters(n,[{left:"£",right:"£",maths:!1}]);for(let e=0;e<p.length;e++)"jseden"==p[e].type?(o[e]={type:"jseden",expression:p[e].data},c.push(p[e].data)):o[e]={type:"text",data:p[e].data};null==r.getAttribute("data-eden-update")&&r.setAttribute("data-eden-update",++dependenciesCreated);let t=()=>{let n="";try{for(let t=0;t<o.length;t++)if("jseden"==o[t].type){let e=o[t].expression;checkTokens(e)==TYPE_EXPRESSION&&(e="DOCUMENT_EDEN_"+DocumentEden.Utils.simpleHash(o[t].expression)),n+=sanitiseResult(root.lookup(e).value(),"maths")}else n+=o[t].data}catch(e){console.log(e),n="Error"}r.innerText="$"+n+"$",Reveal&&Reveal.renderMath(r)};0==c.length&&t(),c.forEach(e=>{DocumentEden.createDependency(e,r.getAttribute("data-eden-update"),t)})}}catch(e){s.appendChild(document.createTextNode(a[t].rawData))}s.appendChild(r)}return s},DocumentEden.Utils.isNumeric=function(e){return"string"==typeof e&&!isNaN(e)&&!isNaN(parseFloat(e))},DocumentEden.Utils.simpleHash=t=>{let n=0;for(let e=0;e<t.length;e++){var o=t.charCodeAt(e);n=(n<<5)-n+o}return(n>>>0).toString(36).padStart(7,"0")};let dependenciesCreated=0,findEndOfMath=(DocumentEden.createDependency=function(a,s,d){return new Promise((t,e)=>{let n,o;if(checkTokens(a)==TYPE_EXPRESSION){var r=DocumentEden.Utils.simpleHash(a);if(o="DOCUMENT_EDEN_"+r,void 0===(n=root.lookup(o)).definition){a=o+" is "+a;let e=new Eden.Fragment("f"+r,()=>{e.setSourceInitial(a),e.ast.execute(EdenSymbol.defaultAgent,root.scope,()=>{var e=root.lookup(o).value();root.lookup(o).addJSObserver(o+"_update"+s,d),d(o,e),t(o)})});return}}else o=a,n=root.lookup(o);n.addJSObserver(o+"_update"+s,d);r=root.lookup(o).value();d(o,r),t(o)})},DocumentEden.getDefinition=function(e){e=root.lookup(e);return void 0!==e.origin?[e.origin.type,e.origin.source,e.value()]:[void 0,void 0,e.value()]},window.DocumentEden=DocumentEden,window.checkTokens=checkTokens,window.root=root,window.eden=eden,window.edenProjectLoaded=new Promise(e=>{window.edenProjectLoadedResolve=e}),window.edenProjectLoaded.then(()=>{DocumentEden.refreshElement()}),DocumentEden.saveState=function(){var e=eden.project.ast.scripts.ACTIVE.getSource().split("\n");return e.splice(0,1),e.splice(-1),e.filter(e=>!(e.startsWith("jseden_")||e.startsWith("view")||e.startsWith("background_"))).join("\n")},DocumentEden.loadState=function(e,t){let n=new Eden.Fragment("loadState"+t,()=>{n.setSourceInitial(e),n.ast.execute(EdenSymbol.defaultAgent,root.scope,()=>{})})},DocumentEden.simpleLookup=function(e){Eden.Selectors.query(e,void 0,{minimum:1,options:{external:!0}},e=>{console.log(e)})},DocumentEden.callJSFunction=function(t,n){try{let e;var o=t.lookup("jsName").value(n);try{e=jsFunctions[o](t.lookup("params").value(n))}catch(e){console.error(e)}if("object"!=typeof e||"function"!=typeof e.then)return e;{let o=[];for(let e=0;e<t.currentObservables.length;e++)o.push(t.currentObservables[e]);e.then(t=>{for(let e=0;e<o.length;e++){var n=o[e];n.cache.value=t,n.cache.up_to_date=!0,n.expireSubscribers(),n.fireJSObservers()}})}}catch(e){console.error(e)}},window.DocumentEden=DocumentEden,function(e,t,n){let o=n,r=0;for(var a=e.length;o<t.length;){var s=t[o];if(r<=0&&t.slice(o,o+a)===e)return o;"\\"===s?o++:"{"===s?r++:"}"===s&&r--,o++}return-1}),escapeRegex=function(e){return e.replace(/[-/\\^$*+?.()|[\]{}]/g,"\\$&")},amsRegex=/^\\begin{/,splitAtDelimiters=function(t,e){for(var n=[],o=new RegExp("("+e.map(e=>escapeRegex(e.left)).join("|")+")");-1!==(r=t.search(o));){0<r&&(n.push({type:"text",data:t.slice(0,r)}),t=t.slice(r));var r,a=e.findIndex(e=>t.startsWith(e.left));if(-1===(r=findEndOfMath(e[a].right,t,e[a].left.length)))break;var s=t.slice(0,r+e[a].right.length),d=amsRegex.test(s)?s:t.slice(e[a].left.length,r);n.push({type:e[a].maths?"jsedenmaths":"jseden",data:d,rawData:s}),t=t.slice(r+e[a].right.length)}return""!==t&&n.push({type:"text",data:t}),n};